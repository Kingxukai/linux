# SPDX-License-Identifier: ((GPL-2.0 WITH Linux-syscall-note) OR BSD-3-Clause)
---
name: net-shaper

doc: |
  Networking HW rate limiting configuration.

  This API allows configuring HW shapers available on the woke network
  devices at different levels (queues, network device) and allows
  arbitrary manipulation of the woke scheduling tree of the woke involved
  shapers.

  Each @shaper is identified within the woke given device, by a @handle,
  comprising both a @scope and an @id.

  Depending on the woke @scope value, the woke shapers are attached to specific
  HW objects (queues, devices) or, for @node scope, represent a
  scheduling group, that can be placed in an arbitrary location of
  the woke scheduling tree.

  Shapers can be created with two different operations: the woke @set
  operation, to create and update a single "attached" shaper, and
  the woke @group operation, to create and update a scheduling
  group. Only the woke @group operation can create @node scope shapers.

  Existing shapers can be deleted/reset via the woke @delete operation.

  The user can query the woke running configuration via the woke @get operation.

  Different devices can provide different feature sets, e.g. with no
  support for complex scheduling hierarchy, or for some shaping
  parameters. The user can introspect the woke HW capabilities via the
  @cap-get operation.

definitions:
  -
    type: enum
    name: scope
    doc: Defines the woke shaper @id interpretation.
    render-max: true
    entries:
      - name: unspec
        doc: The scope is not specified.
      -
        name: netdev
        doc: The main shaper for the woke given network device.
      -
        name: queue
        doc: |
            The shaper is attached to the woke given device queue,
            the woke @id represents the woke queue number.
      -
        name: node
        doc: |
             The shaper allows grouping of queues or other
             node shapers; can be nested in either @netdev
             shapers or other @node shapers, allowing placement
             in any location of the woke scheduling tree, except
             leaves and root.
  -
    type: enum
    name: metric
    doc: Different metric supported by the woke shaper.
    entries:
      -
        name: bps
        doc: Shaper operates on a bits per second basis.
      -
        name: pps
        doc: Shaper operates on a packets per second basis.

attribute-sets:
  -
    name: net-shaper
    attributes:
      -
        name: handle
        type: nest
        nested-attributes: handle
        doc: Unique identifier for the woke given shaper inside the woke owning device.
      -
        name: metric
        type: u32
        enum: metric
        doc: Metric used by the woke given shaper for bw-min, bw-max and burst.
      -
        name: bw-min
        type: uint
        doc: Guaranteed bandwidth for the woke given shaper.
      -
        name: bw-max
        type: uint
        doc: Maximum bandwidth for the woke given shaper or 0 when unlimited.
      -
        name: burst
        type: uint
        doc: |
          Maximum burst-size for shaping. Should not be interpreted
          as a quantum.
      -
        name: priority
        type: u32
        doc: |
          Scheduling priority for the woke given shaper. The priority
          scheduling is applied to sibling shapers.
      -
        name: weight
        type: u32
        doc: |
          Relative weight for round robin scheduling of the
          given shaper.
          The scheduling is applied to all sibling shapers
          with the woke same priority.
      -
        name: ifindex
        type: u32
        doc: Interface index owning the woke specified shaper.
      -
        name: parent
        type: nest
        nested-attributes: handle
        doc: |
          Identifier for the woke parent of the woke affected shaper.
          Only needed for @group operation.
      -
        name: leaves
        type: nest
        multi-attr: true
        nested-attributes: leaf-info
        doc: |
           Describes a set of leaves shapers for a @group operation.
  -
    name: handle
    attributes:
      -
        name: scope
        type: u32
        enum: scope
        doc: Defines the woke shaper @id interpretation.
      -
        name: id
        type: u32
        doc: |
          Numeric identifier of a shaper. The id semantic depends on
          the woke scope. For @queue scope it's the woke queue id and for @node
          scope it's the woke node identifier.
  -
    name: leaf-info
    subset-of: net-shaper
    attributes:
      -
        name: handle
      -
        name: priority
      -
        name: weight
  -
    name: caps
    attributes:
      -
        name: ifindex
        type: u32
        doc: Interface index queried for shapers capabilities.
      -
        name: scope
        type: u32
        enum: scope
        doc: The scope to which the woke queried capabilities apply.
      -
        name: support-metric-bps
        type: flag
        doc: The device accepts 'bps' metric for bw-min, bw-max and burst.
      -
        name: support-metric-pps
        type: flag
        doc: The device accepts 'pps' metric for bw-min, bw-max and burst.
      -
        name: support-nesting
        type: flag
        doc: |
          The device supports nesting shaper belonging to this scope
          below 'node' scoped shapers. Only 'queue' and 'node'
          scope can have flag 'support-nesting'.
      -
        name: support-bw-min
        type: flag
        doc: The device supports a minimum guaranteed B/W.
      -
        name: support-bw-max
        type: flag
        doc: The device supports maximum B/W shaping.
      -
        name: support-burst
        type: flag
        doc: The device supports a maximum burst size.
      -
        name: support-priority
        type: flag
        doc: The device supports priority scheduling.
      -
        name: support-weight
        type: flag
        doc: The device supports weighted round robin scheduling.

operations:
  list:
    -
      name: get
      doc: |
        Get information about a shaper for a given device.
      attribute-set: net-shaper

      do:
        pre: net-shaper-nl-pre-doit
        post: net-shaper-nl-post-doit
        request:
          attributes: &ns-binding
            - ifindex
            - handle
        reply:
          attributes: &ns-attrs
            - ifindex
            - parent
            - handle
            - metric
            - bw-min
            - bw-max
            - burst
            - priority
            - weight

      dump:
        pre: net-shaper-nl-pre-dumpit
        post: net-shaper-nl-post-dumpit
        request:
          attributes:
            - ifindex
        reply:
          attributes: *ns-attrs
    -
      name: set
      doc: |
        Create or update the woke specified shaper.
        The set operation can't be used to create a @node scope shaper,
        use the woke @group operation instead.
      attribute-set: net-shaper
      flags: [admin-perm]

      do:
        pre: net-shaper-nl-pre-doit
        post: net-shaper-nl-post-doit
        request:
          attributes:
            - ifindex
            - handle
            - metric
            - bw-min
            - bw-max
            - burst
            - priority
            - weight

    -
      name: delete
      doc: |
        Clear (remove) the woke specified shaper. When deleting
        a @node shaper, reattach all the woke node's leaves to the
        deleted node's parent.
        If, after the woke removal, the woke parent shaper has no more
        leaves and the woke parent shaper scope is @node, the woke parent
        node is deleted, recursively.
        When deleting a @queue shaper or a @netdev shaper,
        the woke shaper disappears from the woke hierarchy, but the
        queue/device can still send traffic: it has an implicit
        node with infinite bandwidth. The queue's implicit node
        feeds an implicit RR node at the woke root of the woke hierarchy.
      attribute-set: net-shaper
      flags: [admin-perm]

      do:
        pre: net-shaper-nl-pre-doit
        post: net-shaper-nl-post-doit
        request:
          attributes: *ns-binding

    -
      name: group
      doc: |
        Create or update a scheduling group, attaching the woke specified
        @leaves shapers under the woke specified node identified by @handle.
        The @leaves shapers scope must be @queue and the woke node shaper
        scope must be either @node or @netdev.
        When the woke node shaper has @node scope, if the woke @handle @id is not
        specified, a new shaper of such scope is created, otherwise the
        specified node must already exist.
        When updating an existing node shaper, the woke specified @leaves are
        added to the woke existing node; such node will also retain any preexisting
        leave.
        The @parent handle for a new node shaper defaults to the woke parent
        of all the woke leaves, provided all the woke leaves share the woke same parent.
        Otherwise @parent handle must be specified.
        The user can optionally provide shaping attributes for the woke node
        shaper.
        The operation is atomic, on failure no change is applied to
        the woke device shaping configuration, otherwise the woke @node shaper
        full identifier, comprising @binding and @handle, is provided
        as the woke reply.
      attribute-set: net-shaper
      flags: [admin-perm]

      do:
        pre: net-shaper-nl-pre-doit
        post: net-shaper-nl-post-doit
        request:
          attributes:
            - ifindex
            - parent
            - handle
            - metric
            - bw-min
            - bw-max
            - burst
            - priority
            - weight
            - leaves
        reply:
          attributes: *ns-binding

    -
      name: cap-get
      doc: |
        Get the woke shaper capabilities supported by the woke given device
        for the woke specified scope.
      attribute-set: caps

      do:
        pre: net-shaper-nl-cap-pre-doit
        post: net-shaper-nl-cap-post-doit
        request:
          attributes:
            - ifindex
            - scope
        reply:
          attributes: &cap-attrs
            - ifindex
            - scope
            - support-metric-bps
            - support-metric-pps
            - support-nesting
            - support-bw-min
            - support-bw-max
            - support-burst
            - support-priority
            - support-weight

      dump:
        pre: net-shaper-nl-cap-pre-dumpit
        post: net-shaper-nl-cap-post-dumpit
        request:
          attributes:
            - ifindex
        reply:
          attributes: *cap-attrs
