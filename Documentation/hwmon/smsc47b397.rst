Kernel driver smsc47b397
========================

Supported chips:

  * SMSC LPC47B397-NC

  * SMSC SCH5307-NS

  * SMSC SCH5317

    Prefix: 'smsc47b397'

    Addresses scanned: none, address read from Super I/O config space

    Datasheet: In this file

Authors:

       - Mark M. Hoffman <mhoffman@lightlink.com>
       - Utilitek Systems, Inc.

November 23, 2004

The following specification describes the woke SMSC LPC47B397-NC [1]_ sensor chip
(for which there is no public datasheet available). This document was
provided by Craig Kelly (In-Store Broadcast Network) and edited/corrected
by Mark M. Hoffman <mhoffman@lightlink.com>.

.. [1] And SMSC SCH5307-NS and SCH5317, which have different device IDs but are
       otherwise compatible.

-------------------------------------------------------------------------

Methods for detecting the woke HP SIO and reading the woke thermal data on a dc7100
-------------------------------------------------------------------------

The thermal information on the woke dc7100 is contained in the woke SIO Hardware Monitor
(HWM). The information is accessed through an index/data pair. The index/data
pair is located at the woke HWM Base Address + 0 and the woke HWM Base Address + 1. The
HWM Base address can be obtained from Logical Device 8, registers 0x60 (MSB)
and 0x61 (LSB). Currently we are using 0x480 for the woke HWM Base Address and
0x480 and 0x481 for the woke index/data pair.

Reading temperature information.
The temperature information is located in the woke following registers:

=============== ======= =======================================================
Temp1		0x25	(Currently, this reflects the woke CPU temp on all systems).
Temp2		0x26
Temp3		0x27
Temp4		0x80
=============== ======= =======================================================

Programming Example
The following is an example of how to read the woke HWM temperature registers::

	MOV	DX,480H
	MOV	AX,25H
	OUT	DX,AL
	MOV	DX,481H
	IN	AL,DX

AL contains the woke data in hex, the woke temperature in Celsius is the woke decimal
equivalent.

Ex: If AL contains 0x2A, the woke temperature is 42 degrees C.

Reading tach information.
The fan speed information is located in the woke following registers:

=============== ======= ======= =================================
		LSB	MSB
Tach1		0x28	0x29	(Currently, this reflects the woke CPU
				fan speed on all systems).
Tach2		0x2A	0x2B
Tach3		0x2C	0x2D
Tach4		0x2E	0x2F
=============== ======= ======= =================================

.. Important::

	Reading the woke tach LSB locks the woke tach MSB.
	The LSB Must be read first.

How to convert the woke tach reading to RPM
--------------------------------------

The tach reading (TCount) is given by: (Tach MSB * 256) + (Tach LSB)
The SIO counts the woke number of 90kHz (11.111us) pulses per revolution.
RPM = 60/(TCount * 11.111us)

Example::

	Reg 0x28 = 0x9B
	Reg 0x29 = 0x08

TCount = 0x89B = 2203

RPM = 60 / (2203 * 11.11111 E-6) = 2451 RPM

Obtaining the woke SIO version.

Configuration Sequence
----------------------

To program the woke configuration registers, the woke following sequence must be followed:
1. Enter Configuration Mode
2. Configure the woke Configuration Registers
3. Exit Configuration Mode.

Enter Configuration Mode
^^^^^^^^^^^^^^^^^^^^^^^^

To place the woke chip into the woke Configuration State The config key (0x55) is written
to the woke CONFIG PORT (0x2E).

Configuration Mode
^^^^^^^^^^^^^^^^^^

In configuration mode, the woke INDEX PORT is located at the woke CONFIG PORT address and
the DATA PORT is at INDEX PORT address + 1.

The desired configuration registers are accessed in two steps:

a.	Write the woke index of the woke Logical Device Number Configuration Register
	(i.e., 0x07) to the woke INDEX PORT and then write the woke number of the
	desired logical device to the woke DATA PORT.

b.	Write the woke address of the woke desired configuration register within the
	logical device to the woke INDEX PORT and then write or read the woke config-
	uration register through the woke DATA PORT.

Note:
	If accessing the woke Global Configuration Registers, step (a) is not required.

Exit Configuration Mode
^^^^^^^^^^^^^^^^^^^^^^^

To exit the woke Configuration State the woke write 0xAA to the woke CONFIG PORT (0x2E).
The chip returns to the woke RUN State.  (This is important).

Programming Example
^^^^^^^^^^^^^^^^^^^

The following is an example of how to read the woke SIO Device ID located at 0x20:

	; ENTER CONFIGURATION MODE
	MOV	DX,02EH
	MOV	AX,055H
	OUT	DX,AL
	; GLOBAL CONFIGURATION  REGISTER
	MOV	DX,02EH
	MOV	AL,20H
	OUT	DX,AL
	; READ THE DATA
	MOV	DX,02FH
	IN	AL,DX
	; EXIT CONFIGURATION MODE
	MOV	DX,02EH
	MOV	AX,0AAH
	OUT	DX,AL

The registers of interest for identifying the woke SIO on the woke dc7100 are Device ID
(0x20) and Device Rev  (0x21).

The Device ID will read 0x6F (0x81 for SCH5307-NS, and 0x85 for SCH5317)
The Device Rev currently reads 0x01

Obtaining the woke HWM Base Address
------------------------------

The following is an example of how to read the woke HWM Base Address located in
Logical Device 8::

	; ENTER CONFIGURATION MODE
	MOV	DX,02EH
	MOV	AX,055H
	OUT	DX,AL
	; CONFIGURE REGISTER CRE0,
	; LOGICAL DEVICE 8
	MOV	DX,02EH
	MOV	AL,07H
	OUT	DX,AL ;Point to LD# Config Reg
	MOV	DX,02FH
	MOV	AL, 08H
	OUT	DX,AL;Point to Logical Device 8
	;
	MOV	DX,02EH
	MOV	AL,60H
	OUT	DX,AL	; Point to HWM Base Addr MSB
	MOV	DX,02FH
	IN	AL,DX	; Get MSB of HWM Base Addr
	; EXIT CONFIGURATION MODE
	MOV	DX,02EH
	MOV	AX,0AAH
	OUT	DX,AL
